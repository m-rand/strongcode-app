'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'

interface ProgramData {
  client: {
    name: string
    delta: string
  }
  program_info: {
    block: string
    start_date: string
    weeks: number
  }
  calculated: {
    [lift: string]: {
      _summary: {
        total_nl: number
        block_ari: number
        zone_distribution: { [zone: string]: number }
        zone_totals: { [zone: string]: number }
      }
      [key: string]: any
    }
  }
}

export default function CreateProgram() {
  const router = useRouter()
  const [loading, setLoading] = useState(false)
  const [calculatedResults, setCalculatedResults] = useState<ProgramData | null>(null)
  const [isSaved, setIsSaved] = useState(false)
  const [isNewClient, setIsNewClient] = useState(true)

  // Form state
  const [formData, setFormData] = useState({
    // Client info
    clientName: 'Katerina Balasova',
    delta: 'advanced',
    block: 'prep',

    // Lift info
    lift: 'squat',
    oneRM: 142.5,
    rounding: 2.5,
    volume: 350,

    // Weights for zones
    weight_65: 93.0,
    weight_75: 107.5,
    weight_85: 121.0,
    weight_90: 132.5,
    weight_95: 135.0,

    // Intensity distribution
    zone_75_percent: 45,
    zone_85_percent: 13,
    zone_90_total_reps: 4,
    zone_95_total_reps: 0,

    // Volume patterns
    volume_pattern_main: '3a',
    volume_pattern_8190: '3a',

    // Sessions
    sessions_per_week: 3,
    session_distribution: 'd25_33_42',
  })

  const handleCalculate = async (e: React.FormEvent) => {
    e.preventDefault()
    setLoading(true)
    setIsSaved(false)

    try {
      // Call API to calculate targets
      const response = await fetch('/api/create-program', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData),
      })

      if (!response.ok) {
        throw new Error('Failed to calculate program')
      }

      const result = await response.json()

      // Load the calculated program data
      const programResponse = await fetch(`/api/program?client=${result.client}&filename=${result.filename}`)
      const programData = await programResponse.json()

      setCalculatedResults(programData)
    } catch (error) {
      console.error('Error calculating program:', error)
      alert('Nepodařilo se vypočítat program')
    } finally {
      setLoading(false)
    }
  }

  const handleSave = async () => {
    // Program is already saved by the API, just mark as saved
    setIsSaved(true)
    alert('Program byl úspěšně uložen!')
  }

  // Calculate weight from 1RM and percentage
  const calculateWeight = (oneRM: number, percentage: number, rounding: number): number => {
    const raw = oneRM * (percentage / 100)
    return Math.round(raw / rounding) * rounding
  }

  // Calculate actual percentage from weight and 1RM
  const calculateActualPercentage = (weight: number, oneRM: number): number => {
    if (oneRM === 0) return 0
    return Math.round((weight / oneRM) * 100 * 10) / 10 // Round to 1 decimal
  }

  // Calculate percentage from absolute reps and total volume
  const calculatePercentageFromReps = (reps: number, totalVolume: number): number => {
    if (totalVolume === 0) return 0
    return Math.round((reps / totalVolume) * 100 * 10) / 10 // Round to 1 decimal
  }

  // Update field and auto-calculate weights if 1RM or rounding changes
  const updateField = (field: string, value: any) => {
    setFormData(prev => {
      const newData = { ...prev, [field]: value }

      // Auto-calculate zone weights when 1RM or rounding changes
      if (field === 'oneRM' || field === 'rounding') {
        const oneRM = field === 'oneRM' ? value : prev.oneRM
        const rounding = field === 'rounding' ? value : prev.rounding

        newData.weight_65 = calculateWeight(oneRM, 65, rounding)
        newData.weight_75 = calculateWeight(oneRM, 75, rounding)
        newData.weight_85 = calculateWeight(oneRM, 85, rounding)
        newData.weight_90 = calculateWeight(oneRM, 92.5, rounding) // 90% zone uses 92.5% as central weight
        newData.weight_95 = calculateWeight(oneRM, 95, rounding)
      }

      return newData
    })
  }

  return (
    <main className="min-h-screen p-8 bg-gray-50">
      <div className="max-w-4xl mx-auto">
        <header className="mb-8">
          <h1 className="text-4xl font-bold text-gray-900 mb-2">
            Vytvořit Nový Program
          </h1>
          <p className="text-gray-600">
            Zadej parametry pro výpočet tréninkového plánu
          </p>
        </header>

        <form onSubmit={handleCalculate} className="space-y-6">
          {/* Client Selector */}
          <div className="bg-white rounded-lg shadow-md p-6">
            <h2 className="text-xl font-semibold mb-4">Výběr klienta</h2>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Typ záznamu
                </label>
                <select
                  value={isNewClient ? 'new' : 'existing'}
                  onChange={(e) => setIsNewClient(e.target.value === 'new')}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md"
                >
                  <option value="new">Nový klient</option>
                  <option value="existing">Existující klient</option>
                </select>
              </div>
              {!isNewClient && (
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Vybrat klienta
                  </label>
                  <select
                    className="w-full px-3 py-2 border border-gray-300 rounded-md"
                    onChange={(e) => updateField('clientName', e.target.value)}
                  >
                    <option value="Katerina Balasova">Katerina Balasova</option>
                  </select>
                </div>
              )}
            </div>
          </div>

          {/* Client Info */}
          <div className="bg-white rounded-lg shadow-md p-6">
            <h2 className="text-xl font-semibold mb-4">Informace o klientovi</h2>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Jméno klienta
                </label>
                <input
                  type="text"
                  value={formData.clientName}
                  onChange={(e) => updateField('clientName', e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md"
                  required
                  disabled={!isNewClient}
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Úroveň (Delta)
                </label>
                <select
                  value={formData.delta}
                  onChange={(e) => updateField('delta', e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md"
                >
                  <option value="intermediate">Intermediate</option>
                  <option value="advanced">Advanced</option>
                  <option value="elite">Elite</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Block
                </label>
                <select
                  value={formData.block}
                  onChange={(e) => updateField('block', e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md"
                >
                  <option value="prep">Prep</option>
                  <option value="peak">Peak</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Cvik
                </label>
                <select
                  value={formData.lift}
                  onChange={(e) => updateField('lift', e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md"
                >
                  <option value="squat">Squat</option>
                  <option value="bench_press">Bench Press</option>
                  <option value="deadlift">Deadlift</option>
                </select>
              </div>
            </div>
          </div>

          {/* Basic Parameters */}
          <div className="bg-white rounded-lg shadow-md p-6">
            <h2 className="text-xl font-semibold mb-4">Základní parametry</h2>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  1RM (kg)
                </label>
                <input
                  type="number"
                  step="0.5"
                  value={formData.oneRM}
                  onChange={(e) => updateField('oneRM', parseFloat(e.target.value))}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md"
                  required
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Rounding (kg)
                </label>
                <select
                  value={formData.rounding}
                  onChange={(e) => updateField('rounding', parseFloat(e.target.value))}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md"
                >
                  <option value="1.0">1.0</option>
                  <option value="2.5">2.5</option>
                  <option value="5.0">5.0</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Volume (Monthly NL)
                </label>
                <input
                  type="number"
                  value={formData.volume}
                  onChange={(e) => updateField('volume', parseInt(e.target.value))}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md"
                  required
                />
              </div>
            </div>
          </div>

          {/* Zone Weights */}
          <div className="bg-white rounded-lg shadow-md p-6">
            <h2 className="text-xl font-semibold mb-4">Váhy pro jednotlivé zóny (kg)</h2>
            <p className="text-sm text-gray-600 mb-4">
              Váhy se automaticky vypočítají z 1RM. Můžeš je upravit ručně - zobrazí se pak skutečné procento.
            </p>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  65% zóna
                  <span className="ml-2 text-xs text-gray-500">
                    (skutečně: {calculateActualPercentage(formData.weight_65, formData.oneRM)}%)
                  </span>
                </label>
                <input
                  type="number"
                  step="0.5"
                  value={formData.weight_65}
                  onChange={(e) => updateField('weight_65', parseFloat(e.target.value))}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-900 placeholder-gray-400"
                  placeholder="Auto-vypočítáno"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  75% zóna
                  <span className="ml-2 text-xs text-gray-500">
                    (skutečně: {calculateActualPercentage(formData.weight_75, formData.oneRM)}%)
                  </span>
                </label>
                <input
                  type="number"
                  step="0.5"
                  value={formData.weight_75}
                  onChange={(e) => updateField('weight_75', parseFloat(e.target.value))}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50"
                  placeholder="Auto-vypočítáno"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  85% zóna
                  <span className="ml-2 text-xs text-gray-500">
                    (skutečně: {calculateActualPercentage(formData.weight_85, formData.oneRM)}%)
                  </span>
                </label>
                <input
                  type="number"
                  step="0.5"
                  value={formData.weight_85}
                  onChange={(e) => updateField('weight_85', parseFloat(e.target.value))}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50"
                  placeholder="Auto-vypočítáno"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  90% zóna (92.5% centrální váha)
                  <span className="ml-2 text-xs text-gray-500">
                    (skutečně: {calculateActualPercentage(formData.weight_90, formData.oneRM)}%)
                  </span>
                </label>
                <input
                  type="number"
                  step="0.5"
                  value={formData.weight_90}
                  onChange={(e) => updateField('weight_90', parseFloat(e.target.value))}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50"
                  placeholder="Auto-vypočítáno"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  95% zóna
                  <span className="ml-2 text-xs text-gray-500">
                    (skutečně: {calculateActualPercentage(formData.weight_95, formData.oneRM)}%)
                  </span>
                </label>
                <input
                  type="number"
                  step="0.5"
                  value={formData.weight_95}
                  onChange={(e) => updateField('weight_95', parseFloat(e.target.value))}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50"
                  placeholder="Auto-vypočítáno"
                />
              </div>
            </div>
          </div>

          {/* Intensity Distribution */}
          <div className="bg-white rounded-lg shadow-md p-6">
            <h2 className="text-xl font-semibold mb-4">Distribuce intenzity</h2>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  65% zóna (% z celkového objemu)
                </label>
                <input
                  type="number"
                  value={Math.round((100 - formData.zone_75_percent - formData.zone_85_percent - calculatePercentageFromReps(formData.zone_90_total_reps, formData.volume) - calculatePercentageFromReps(formData.zone_95_total_reps, formData.volume)) * 10) / 10}
                  disabled
                  className="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600"
                />
                <p className="text-xs text-gray-500 mt-1">
                  Dopočítává se automaticky jako zbytek do 100%
                </p>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  75% zóna (% z celkového objemu)
                </label>
                <input
                  type="number"
                  value={formData.zone_75_percent}
                  onChange={(e) => updateField('zone_75_percent', parseInt(e.target.value))}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  85% zóna (% z celkového objemu)
                </label>
                <input
                  type="number"
                  value={formData.zone_85_percent}
                  onChange={(e) => updateField('zone_85_percent', parseInt(e.target.value))}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  90% zóna (počet opakování)
                  <span className="ml-2 text-xs text-gray-500">
                    = {calculatePercentageFromReps(formData.zone_90_total_reps, formData.volume)}% z objemu
                  </span>
                </label>
                <input
                  type="number"
                  value={formData.zone_90_total_reps}
                  onChange={(e) => updateField('zone_90_total_reps', parseInt(e.target.value))}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  95% zóna (počet opakování)
                  <span className="ml-2 text-xs text-gray-500">
                    = {calculatePercentageFromReps(formData.zone_95_total_reps, formData.volume)}% z objemu
                  </span>
                </label>
                <input
                  type="number"
                  value={formData.zone_95_total_reps}
                  onChange={(e) => updateField('zone_95_total_reps', parseInt(e.target.value))}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md"
                />
              </div>
            </div>
          </div>

          {/* Volume Patterns */}
          <div className="bg-white rounded-lg shadow-md p-6">
            <h2 className="text-xl font-semibold mb-4">Volume Patterns</h2>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Main Pattern (65%, 75%)
                </label>
                <select
                  value={formData.volume_pattern_main}
                  onChange={(e) => updateField('volume_pattern_main', e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md"
                >
                  {['1', '2a', '2b', '2c', '3a', '3b', '3c', '4', '1-3a', '1-3b', '3-1a', '3-1b', '2-4a', '2-4b', '4-2a', '4-2b'].map(p => (
                    <option key={p} value={p}>{p}</option>
                  ))}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  81-90% Pattern
                </label>
                <select
                  value={formData.volume_pattern_8190}
                  onChange={(e) => updateField('volume_pattern_8190', e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md"
                >
                  {['1', '2a', '2b', '2c', '3a', '3b', '3c', '4', '1-3a', '1-3b', '3-1a', '3-1b', '2-4a', '2-4b', '4-2a', '4-2b'].map(p => (
                    <option key={p} value={p}>{p}</option>
                  ))}
                </select>
              </div>
            </div>
          </div>

          {/* Sessions */}
          <div className="bg-white rounded-lg shadow-md p-6">
            <h2 className="text-xl font-semibold mb-4">Tréninkové sessions</h2>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Počet sessions v týdnu
                </label>
                <select
                  value={formData.sessions_per_week}
                  onChange={(e) => updateField('sessions_per_week', parseInt(e.target.value))}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md"
                >
                  <option value="2">2</option>
                  <option value="3">3</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Session Distribution
                </label>
                <select
                  value={formData.session_distribution}
                  onChange={(e) => updateField('session_distribution', e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md"
                >
                  {formData.sessions_per_week === 3 ? (
                    <>
                      <option value="d25_33_42">d25_33_42 (L-M-H)</option>
                      <option value="d20_35_45">d20_35_45</option>
                      <option value="d22_28_50">d22_28_50</option>
                      <option value="d20_30_50">d20_30_50</option>
                      <option value="d15_35_50">d15_35_50</option>
                      <option value="d15_30_55">d15_30_55</option>
                    </>
                  ) : (
                    <>
                      <option value="d40_60">d40_60</option>
                      <option value="d35_65">d35_65</option>
                      <option value="d30_70">d30_70</option>
                      <option value="d25_75">d25_75</option>
                      <option value="d20_80">d20_80</option>
                    </>
                  )}
                </select>
              </div>
            </div>
          </div>

          {/* Submit Button */}
          <div className="flex justify-end gap-4">
            <button
              type="button"
              onClick={() => router.push('/')}
              className="px-6 py-3 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
            >
              Zrušit
            </button>
            <button
              type="submit"
              disabled={loading}
              className="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400"
            >
              {loading ? 'Počítám...' : 'Vypočítat Program'}
            </button>
          </div>
        </form>

        {/* Results Display */}
        {calculatedResults && (
          <div className="mt-8 space-y-6">
            <div className="bg-green-50 border-l-4 border-green-500 p-4">
              <h2 className="text-xl font-semibold text-green-900 mb-2">
                Program úspěšně vypočítán!
              </h2>
              <p className="text-green-700">
                Zkontroluj výsledky níže a klikni na "Uložit" pro finální uložení.
              </p>
            </div>

            {/* Summary */}
            <div className="bg-white rounded-lg shadow-md p-6">
              <h2 className="text-2xl font-semibold mb-4">Souhrn programu</h2>
              {Object.entries(calculatedResults.calculated).map(([lift, liftData]) => {
                const summary = liftData._summary
                return (
                  <div key={lift} className="space-y-4">
                    <h3 className="text-xl font-semibold capitalize">{lift}</h3>
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                      <div className="text-center p-4 bg-blue-50 rounded-lg">
                        <div className="text-3xl font-bold text-blue-600">{summary.total_nl}</div>
                        <div className="text-sm text-gray-600 mt-1">Total Volume (NL)</div>
                      </div>
                      <div className="text-center p-4 bg-green-50 rounded-lg">
                        <div className="text-3xl font-bold text-green-600">{summary.block_ari}%</div>
                        <div className="text-sm text-gray-600 mt-1">Block ARI</div>
                      </div>
                      <div className="text-center p-4 bg-purple-50 rounded-lg">
                        <div className="text-3xl font-bold text-purple-600">{calculatedResults.program_info.weeks}</div>
                        <div className="text-sm text-gray-600 mt-1">Weeks</div>
                      </div>
                    </div>

                    {/* Zone Distribution */}
                    <div className="mt-4">
                      <h4 className="font-semibold mb-2">Intensity Zone Distribution</h4>
                      <div className="overflow-x-auto">
                        <table className="min-w-full">
                          <thead>
                            <tr className="border-b border-gray-200">
                              <th className="text-left py-2 px-3 text-gray-600">Zone</th>
                              <th className="text-right py-2 px-3 text-gray-600">Percentage</th>
                              <th className="text-right py-2 px-3 text-gray-600">Total Reps</th>
                            </tr>
                          </thead>
                          <tbody>
                            {Object.entries(summary.zone_distribution).map(([zone, pct]) => (
                              <tr key={zone} className="border-b border-gray-100">
                                <td className="py-2 px-3 font-medium">{zone}%</td>
                                <td className="py-2 px-3 text-right">{pct}%</td>
                                <td className="py-2 px-3 text-right font-semibold">{summary.zone_totals[zone]}</td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>

                    {/* Weekly Breakdown with Sessions */}
                    <div className="mt-6">
                      <h4 className="font-semibold mb-4">Týdenní rozpis sessions</h4>
                      <div className="space-y-4">
                        {[1, 2, 3, 4].map(weekNum => {
                          const weekData = liftData[`week_${weekNum}`]
                          if (!weekData) return null

                          return (
                            <div key={weekNum} className="border border-gray-200 rounded-lg p-4">
                              <div className="flex justify-between items-center mb-3">
                                <h5 className="text-lg font-semibold">Týden {weekNum}</h5>
                                <div className="flex gap-4">
                                  <span className="text-sm text-gray-600">
                                    Celkem: <span className="font-semibold">{weekData.total_reps} reps</span>
                                  </span>
                                  <span className="text-sm text-gray-600">
                                    ARI: <span className="font-semibold">{weekData.ari}%</span>
                                  </span>
                                </div>
                              </div>

                              {/* Sessions */}
                              <div className="grid md:grid-cols-3 gap-3">
                                {Object.entries(weekData.sessions).map(([day, sessionData]: [string, any]) => (
                                  <div key={day} className="bg-gray-50 rounded p-3">
                                    <div className="font-medium capitalize mb-2">{day}</div>
                                    <div className="text-sm text-gray-600 mb-2">
                                      Celkem: {sessionData.total} reps
                                    </div>
                                    <div className="space-y-1 text-xs">
                                      {Object.entries(sessionData.zones).map(([zone, reps]: [string, any]) => (
                                        reps > 0 && (
                                          <div key={zone} className="flex justify-between">
                                            <span>{zone}%:</span>
                                            <span className="font-medium">{reps} reps</span>
                                          </div>
                                        )
                                      ))}
                                    </div>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )
                        })}
                      </div>
                    </div>
                  </div>
                )
              })}
            </div>

            {/* Save Button */}
            <div className="flex justify-end gap-4">
              <button
                onClick={() => setCalculatedResults(null)}
                className="px-6 py-3 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
              >
                Upravit vstup
              </button>
              <button
                onClick={handleSave}
                disabled={isSaved}
                className="px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400"
              >
                {isSaved ? 'Uloženo ✓' : 'Uložit program'}
              </button>
            </div>
          </div>
        )}
      </div>
    </main>
  )
}
